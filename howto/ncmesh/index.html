<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        
        
        
        <link rel="shortcut icon" href="/img/favicon.ico">
        <meta name="keywords" content="Finite Element Library,Finite Element Code,Finite Element Method Library,Finite Element Method Code,Finite Element C++,Finite Element Method C++,Finite Element Library C++,Finite Element Code C++,FEM Code,FEM Library,FEM C++">
        <meta name="google-site-verification" content="45K56TawSdzbgy-uDtfJdYwp7zaVdL3fIAGYt869wwU" />
<!--	<title></title>  -->
        <title>MFEM - Finite Element Discretization Library</title>

        <link href="../../css/bootstrap-mfem.min.css" rel="stylesheet">
        <link href="../../css/font-awesome-4.0.3.css" rel="stylesheet">
        <link href="../../css/highlight.css" rel="stylesheet">
        <link href="../../css/base.css" rel="stylesheet">

        <!-- HTML5 shim and Respond.js IE8 support of HTML5 elements and media queries -->
        <!--[if lt IE 9]>
            <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
            <script src="https://oss.maxcdn.com/libs/respond.js/1.3.0/respond.min.js"></script>
        <![endif]-->

	<!-- Google tag (gtag.js) -->
        <script async src="https://www.googletagmanager.com/gtag/js?id=G-NS5XV5TFM6"></script>
        <script>
          window.dataLayer = window.dataLayer || [];
          function gtag(){dataLayer.push(arguments);}
          gtag('js', new Date());
          gtag('config', 'G-NS5XV5TFM6');
        </script>

        
    </head>

    <body>

        <div class="navbar navbar-default navbar-fixed-top" role="navigation">
    <div class="container">

        <!-- Collapsed navigation -->
        <div class="navbar-header">
            <!-- Expander button -->
            <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-collapse">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </button>

            <!-- Main title -->
            <a class="navbar-brand" href="https://mfem.org">MFEM</a>
        </div>

        <script>var base_url = '../..';</script>
        <script data-main="../../mkdocs/js/search.js" src="../../mkdocs/js/require.js"></script>

        <!-- Expanded navigation -->
        <div class="navbar-collapse collapse">
            <!-- Main navigation -->
            <ul class="nav navbar-nav">
            
            
            
            
            
                <li >
                    <!-- Replace "nav_item.url|url" with "nav_item.url" for older mkdocs (before 1.0) -->
                    <a href="../../features/">Features</a>
                </li>
            
            
            
            
            
                <li class="dropdown">
                    <a href="#" class="dropdown-toggle" data-toggle="dropdown">Examples <b class="caret"></b></a>
                    <ul class="dropdown-menu">
                    
                        
                            <li >
                                 <a href="../../examples/">Example Codes</a>
                            </li>
                        
                    
                        
                            <li >
                                 <a href="../../electromagnetics/">Electromagnetics</a>
                            </li>
                        
                    
                        
                            <li >
                                 <a href="../../fluids/">Fluid Dynamics</a>
                            </li>
                        
                    
                        
                            <li >
                                 <a href="../../meshing-miniapps/">Meshing</a>
                            </li>
                        
                    
                        
                            <li >
                                 <a href="../../nurbs/">NURBS Discretization</a>
                            </li>
                        
                    
                        
                            <li >
                                 <a href="../../autodiff/">Automatic Differentiation</a>
                            </li>
                        
                    
                        
                            <li >
                                 <a href="../../tools/">Tools</a>
                            </li>
                        
                    
                        
                            <li >
                                 <a href="../../toys/">Toys</a>
                            </li>
                        
                    
                    </ul>
                </li>
            
            
            
            
            
                <li class="dropdown">
                    <a href="#" class="dropdown-toggle" data-toggle="dropdown">Documentation <b class="caret"></b></a>
                    <ul class="dropdown-menu">
                    
                        
                            <li >
                                 <a href="../../getting-started/">Getting Started</a>
                            </li>
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                            <li >
                                 <a href="../howto-index/">HowTo Articles</a>
                            </li>
                        
                    
                        
                            <li >
                                 <a href="../../fem/">Finite Elements</a>
                            </li>
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                            <li >
                                 <a href="../../performance/">Performance</a>
                            </li>
                        
                    
                        
                    
                        
                            <li >
                                 <a href="../../gpu-support/">GPU Support</a>
                            </li>
                        
                    
                        
                            <li >
                                 <a href="../../mesh-formats/">Mesh Formats</a>
                            </li>
                        
                    
                        
                    
                        
                    
                        
                            <li >
                                 <a href="../../dox/">Doxygen</a>
                            </li>
                        
                    
                        
                            <li >
                                 <a href="../../publications/">Publications</a>
                            </li>
                        
                    
                        
                            <li >
                                 <a href="../../about/">About</a>
                            </li>
                        
                    
                        
                            <li >
                                 <a href="../../search/">ðŸ”Ž Search...</a>
                            </li>
                        
                    
                    </ul>
                </li>
            
            
            
            
            
                <li class="dropdown">
                    <a href="#" class="dropdown-toggle" data-toggle="dropdown">Community <b class="caret"></b></a>
                    <ul class="dropdown-menu">
                    
                        
                            <li >
                                 <a href="../../news/">News</a>
                            </li>
                        
                    
                        
                            <li >
                                 <a href="../../videos/">Videos</a>
                            </li>
                        
                    
                        
                            <li >
                                 <a href="../../seminar/">Seminar</a>
                            </li>
                        
                    
                        
                            <li >
                                 <a href="../../workshop/">Workshop</a>
                            </li>
                        
                    
                        
                    
                        
                    
                        
                    
                        
                            <li >
                                 <a href="../../tutorial/">Tutorial</a>
                            </li>
                        
                    
                    </ul>
                </li>
            
            
            
            
            
                <li >
                    <!-- Replace "nav_item.url|url" with "nav_item.url" for older mkdocs (before 1.0) -->
                    <a href="../../gallery/">Gallery</a>
                </li>
            
            
            
            
            
                <li >
                    <!-- Replace "nav_item.url|url" with "nav_item.url" for older mkdocs (before 1.0) -->
                    <a href="../../download/">Download</a>
                </li>
            
            
            
            </ul>

            <!-- Search, Navigation and Repo links -->
            <ul class="nav navbar-nav navbar-right">
                
                
                <li>
                    <a href="https://github.com/mfem/mfem/">
                        
                            <i class="fa fa-github-square"></i>
                        
                        GitHub
                    </a>
                </li>
                
            </ul>
        </div>
    </div>
</div>

        
        <div class="container">
            
            <div class="col-md-3 visible-xs visible-sm"><div class="bs-sidebar hidden-print affix well" role="complementary">
    <ul class="nav bs-sidenav">
    
        <li class="main active"><a href="#howto-nonconforming-and-amr-meshes">HowTo: Nonconforming and AMR meshes</a></li>
        
            <li><a href="#nonconforming-refinement">Nonconforming refinement</a></li>
        
            <li><a href="#limiting-the-level-of-hanging-nodes">Limiting the level of hanging nodes</a></li>
        
            <li><a href="#anisotropic-refinement">Anisotropic refinement</a></li>
        
            <li><a href="#derefinement">Derefinement</a></li>
        
            <li><a href="#parallel-nonconforming-meshes">Parallel nonconforming meshes</a></li>
        
            <li><a href="#load-balancing">Load balancing</a></li>
        
            <li><a href="#nonconforming-mesh-io">Nonconforming mesh I/O</a></li>
        
    
    
	
           <hr style="background-color:white; height:20px; margin-left:-1px;  margin-right:-1px; margin-top:15px; margin-bottom:10px " />
           <li><a href="../../howto/howto-index/"><i class="fa fa-chevron-circle-left"></i> Back to HowTo Articles</a> </li>
        
	
	
	
    
    </ul>
</div>

<!-- Developer notes:
  See the MkDocs documentation in https://www.mkdocs.org/dev-guide/themes/#page
  and the Jinja2 template API in https://tedboy.github.io/jinja2/index.html
--></div> <!-- toc on top on mobile -->
            <div class="col-md-9" role="main">

<h1 id="howto-nonconforming-and-amr-meshes">HowTo: Nonconforming and AMR meshes</h1>
<p>The <code>Mesh</code> class provides basic element refinement capabilities:</p>
<ul>
<li>All elements may be refined uniformly with <code>Mesh::UniformRefinement</code>.</li>
<li>Local refinement is supported, but only for simplex elements. The method
  <code>Mesh::GeneralRefinement</code> uses recursive bisection in this case.</li>
</ul>
<p>These basic refinement methods preserve mesh conformity, i.e., no hanging nodes
are created. This also means that quadrilaterals and hexahedra cannot be refined
locally by the <code>Mesh</code> class.</p>
<p>For more advanced AMR, MFEM has the class <code>NCMesh</code>:</p>
<ul>
<li>Tensor product element refinement (quad, hex, prism) is supported, including
  anisotropic refinement. Hanging nodes are created and handled transparently.</li>
<li>Triangles and tetrahedra use "red" (isotropic) refinement, also producing
  hanging nodes in this mode.</li>
<li>Derefinement (coarsening) of previously refined elements is possible.</li>
<li>In parallel, the mesh can be load balanced.</li>
</ul>
<p>The user does not interact directly with the <code>NCMesh</code> class &mdash; it is
created behind the scenes, and the <code>Mesh</code> class in nonconforming mode, continually updated
to contain the finest elements of the refinement hierarchy, still serves as an interface
for the user and other MFEM classes.</p>
<p>To switch to the nonconforming mode (or convert and existing conforming <code>Mesh</code>),
you need to call <code>EnsureNCMesh</code>, typically at the beginning after loading the
mesh:</p>
<pre><code class="c++">Mesh *mesh = new Mesh(mesh_file, 1, 1);
mesh-&gt;EnsureNCMesh(true);
</code></pre>

<p>The boolean parameter, if <code>true</code>, forces simplex meshes to use nonconforming
refinement (the default is <code>false</code>).</p>
<h2 id="nonconforming-refinement">Nonconforming refinement</h2>
<p>Once the <code>Mesh</code> is in nonconforming mode, you can simply call <code>Mesh::GeneralRefinement</code>
to locally refine a subset of elements:</p>
<pre><code class="c++">Array&lt;int&gt; refinement_list;
for (int i = 0; i &lt; mesh-&gt;GetNE(); i++)
{
   if (/*element i refinement condition*/)
   {
      refinement_list.Append(i);
   }
}
mesh-&gt;GeneralRefinement(refinement_list);
</code></pre>

<p>The resulting hanging nodes will be treated transparently by the <code>FiniteElementSpace</code> and
<code>BilinearForm</code> classes:</p>
<ul>
<li>
<p><code>FiniteElementSpace</code> will internally construct a conforming interpolation matrix $P$,
  that when applied to a vector of unconstrained ("true") DOFs, will augment the vector
  with interpolated constrained DOFs.</p>
</li>
<li>
<p>Once the linear system $Ax = b$ is assembled, <code>BilinearForm::FormLinearSystem</code> will
  eliminate constrained nodes by transforming the linear system to $P^TAPx = P^Tb$
  (see <code>ex1.cpp</code>).</p>
</li>
<li>
<p>After the reduced system is solved, the conforming solution on all nodes is recovered
  as $y = P x$ with <code>BilinearForm::RecoverFEMSolution</code>.</p>
</li>
</ul>
<h2 id="limiting-the-level-of-hanging-nodes">Limiting the level of hanging nodes</h2>
<p>By default, MFEM does not limit the sizes of adjacent elements in nonconforming meshes.
For some applications, it may be necessary to ensure that the refinement level of neighboring
elements differs by at most one, for example.</p>
<p>The optional parameter <code>nc_limit</code> of <code>Mesh::GeneralRefinement</code> can be used to
control the maximum level of nonconformity. If <code>nc_limit</code> is greater than zero, the
method will automatically perform additional refinements to make sure the difference of
refinement levels of adjacent elements is at most <code>nc_limit</code>.</p>
<h2 id="anisotropic-refinement">Anisotropic refinement</h2>
<p>Uniquely, MFEM offers the capability to perform anisotropic refinement of tensor product
elements in both 2D and 3D. The method <code>Mesh::GeneralRefinement</code> has two overloads, one
taking a simple list of elements to refine (as seen above), and the other taking a list
of <code>struct Refinement { int index; char ref_type; }</code>, where one can specify a refinement
type for each element in the list:</p>
<pre><code class="c++">Array&lt;Refinement&gt; refinement_list;
refinement_list.Append(Refinement(0, 2));
refinement_list.Append(Refinement(1, 4));
mesh-&gt;GeneralRefinement(refinement_list);
</code></pre>

<p>This code will refine the first element (index 0) of the mesh in the Y direction only
(provided it is a quad or hex element) and the second element (index 1)
in the Z direction only. The directions are assumed in the element reference coordinates
and are encoded as follows:</p>
<p><img alt="" src="../../img/formats/reftypes.svg" /></p>
<p>Note that the refinement type is encoded as a 3-bit number, where bits 0, 1, 2 correspond
to the X, Y, Z directions, respectively. Other element geometries allow fewer
but similar refinement types: triangle (3), quadrilateral (1, 2, 3), tetrahedron (7),
prism (3, 4, 7).</p>
<p>In 3D meshes with anisotropic refinements it is easy to arrive at conflicting situations,
where the refined faces of adjacent elements are not subsets of each other. For example,
running the above code on a mesh with two hexahedra adjacent in the X direction will
create an interface that cannot be constrained correctly. In such cases, MFEM will
automatically adjust one side of the interface with additional refinements (called forced
refinements) to ensure that the mesh remains a valid FEM mesh. In pathological cases the
forced refinements may propagate. Using a reasonable <code>nc_limit</code> may reduce this effect.
Nevertheless, a valid mesh is produced in all cases.</p>
<h2 id="derefinement">Derefinement</h2>
<p>To coarsen elements, use the method <code>Mesh::DerefineByError</code>.
The interface is different from refinement, because it is not possible to coarsen
arbitrary groups of fine elements: it is only possible to reintroduce previously existing
coarse elements by undoing their refinement (hence the term "derefinement").</p>
<p>Since one cannot supply the indices of elements that no longer exist in the <code>Mesh</code> class
(the refinement trees are kept internal to <code>NCMesh</code>), the method
<code>DerefineByError</code> works indirectly by taking an array of "error" values corresponding to
each element of the current <code>Mesh</code>. If the sum of error values of the children of some
coarse element is below a supplied threshold, the children are removed and the coarse
element is restored in <code>Mesh</code>.</p>
<p>If the user specifies a nonzero <code>nc_limit</code>, care is taken not to derefine elements that
are needed to keep the required level of nonconformity.</p>
<p><em>Note: derefinement is not yet supported for meshes containing 3D anisotropic refinements.</em></p>
<h2 id="parallel-nonconforming-meshes">Parallel nonconforming meshes</h2>
<p>Just as the <code>Mesh</code> class has a parallel counterpart (<code>ParMesh</code>), so does the <code>NCMesh</code>
class have a parallel descendant: <code>ParNCMesh</code>. The parallel class is again kept
internal and the user can continue to interact with the standard <code>ParMesh</code> class
(see examples <code>ex1p</code>, <code>ex6p</code> and <code>ex15p</code>).</p>
<p>The refinement hierarchy in parallel NC mode is fully distributed and scales to billions
of elements and hundreds of thousands of MPI tasks. Ghost elements are automatically tracked
by the <code>ParNCMesh</code> class, so that a parallel conforming interpolation matrix can be constructed
by <code>ParFiniteElementSpace</code>. Depending on the assembly level, <code>ParBilinearForm</code>
will either explicitly assemble the parallel $P^TAP$ system using the Hypre library, or
the action of the $P$ matrix will be applied during solver iterations.</p>
<p>Parallel refinement is still done through <code>Mesh::GeneralRefinement</code> inherited by the <code>ParMesh</code>
class. The method takes local element indices and works the same as in serial. All parallel
concerns such as keeping the ghost layers synchronized are handled internally in <code>ParNCMesh</code>.</p>
<p><em>Note: parallel anisotropic refinement of 3D meshes is not supported yet.</em></p>
<p>After each mesh operation (refinement, derefinement, load balancing) the <code>ParMesh</code> is
updated to reflect the current parallel mesh state (minus the ghost elements, which are not exported to <code>ParMesh</code>). Communication groups, used in conforming mode for reductions/broadcasts over parallel solution vectors, are approximated in the NC mode as if the mesh was cut along the nonconforming interfaces.</p>
<h2 id="load-balancing">Load balancing</h2>
<p>In conforming mode, a serial <code>Mesh</code> can only be partitioned statically (with METIS) when
constructing a <code>ParMesh</code>. In nonconforming mode, the internal <code>ParNCMesh</code> class is capable
of load balancing the distributed mesh at any time. This functionality is available to the
user through <code>ParMesh::Rebalance</code> (see <code>ex6p</code> and <code>ex15p</code>).</p>
<p>The dynamic load balancing algorithm is based on partitioning a space-filling curve (SFC)
that naturally arises when traversing the distributed refinement trees. Compared to spectral
partitioners like METIS the partitions are not as high quality but the process is extremely
fast and scales to hundreds of thousands of processors.</p>
<p>For best results with SFC-based partitioning, one condition has to be met: the elements
of the coarse <code>Mesh</code> from which the <code>ParMesh</code> is constructed need to be
ordered, ideally as a sequence of face-neighbors. This makes it possible for <code>ParNCMesh</code>
to order the leaves of all refinement trees into a global linear sequence,
which when equipartitioned should produce compact (albeit not minimal surface) mesh partitions.</p>
<p>Take for example a coarse mesh produced by the <code>polar-nc</code> miniapp. Except for two
discontinuities, the elements are mostly ordered as a sequence of face-neighbors:</p>
<p><img src="/howto/img/nc-sfc-1.png" width="60%"/></p>
<p>When we start refining elements (in both serial and parallel), MFEM will try to keep the
space-filling curve continuous by inserting local Hilbert curves in the refined areas (press
<code>Ctrl+O</code> in GLVis to visualize the ordering curve):</p>
<p><img src="/howto/img/nc-sfc-2.png" width="60%"/></p>
<p>In a parallel computation, the global curve is then used for fast assignment of elements
to MPI ranks. In the following run of <code>ex15p</code>, each processor is assigned the same number
of elements (+/- one element). Note that the last partition is discontinuous due to a jump
in ordering in the coarse mesh. This only affects the efficiency of MPI communication &mdash;
the numerical results will be the same regardless of the partitioning.</p>
<p><img src="/howto/img/nc-sfc-3.png" width="60%"/></p>
<p>MFEM provides several methods to help with mesh ordering:</p>
<ul>
<li>
<p>Procedurally generated rectangular grids (<code>Mesh::MakeCartesian2D</code>, <code>Mesh::MakeCartesian3D</code>
  and also <code>MFEM INLINE mesh v1.0</code> files) are by default ordered along a pseudo-Hilbert
  curve. Note that even grid dimensions are recommended, as explained <a href="https://github.com/jakubcerveny/gilbert">here</a>.</p>
</li>
<li>
<p>General unstructured meshes may be ordered by a spatial sort algorithm
  (<code>Mesh::GetHilbertElementOrdering</code>). This is a fast method that will leave a number of
  jumps in complex meshes, but it is still highly recommended over not ordering the mesh at all.</p>
</li>
<li>
<p>High-quality orderings of general meshes can be obtained with the
  <a href="https://github.com/LLNL/gecko">Gecko</a> library, now included directly in MFEM and available
  as <code>Mesh::GetGeckoElementOrdering</code>. The optimization algorithm used is more costly than
  a simple spatial sort, but it should produce better orderings for meshes with complex geometries.
  Beware the exponential cost of increasing the <code>window</code> parameter. Large meshes should probably
  be ordered in a preprocessing step (you may use the <code>mesh-explorer</code> miniapp for that).</p>
</li>
</ul>
<h2 id="nonconforming-mesh-io">Nonconforming mesh I/O</h2>
<p>Nonconforming meshes have their own <a href="../../mesh-format-v1.0/#mfem-nc-mesh-v10">file format</a> <code>MFEM NC mesh v1.0</code>, which supports all the additional internal structures (refinement trees, hanging nodes, etc.) and works for both serial and parallel NC meshes.</p>
<p>The method <code>ParMesh::ParPrint</code> will automatically choose the right format and can be used to
save and restart an AMR computation, as demonstrated in example <code>ex6p</code>.</p>
<p><code>ParMesh::ParPrint</code> should not be confused with the method <code>ParMesh::Print</code>, an analog of
<code>Mesh::Print</code>, which is only suitable for visualization, as it uses the serial <code>MFEM mesh v1.0</code>
format and only adds the parallel shared faces to the output.</p>
<script type="text/x-mathjax-config">MathJax.Hub.Config({TeX: {equationNumbers: {autoNumber: "all"}}, tex2jax: {inlineMath: [['$','$']]}});</script>

<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.2/MathJax.js?config=TeX-AMS_HTML"></script></div>
            <div class="col-md-3 hidden-xs hidden-sm"><div class="bs-sidebar hidden-print affix well" role="complementary">
    <ul class="nav bs-sidenav">
    
        <li class="main active"><a href="#howto-nonconforming-and-amr-meshes">HowTo: Nonconforming and AMR meshes</a></li>
        
            <li><a href="#nonconforming-refinement">Nonconforming refinement</a></li>
        
            <li><a href="#limiting-the-level-of-hanging-nodes">Limiting the level of hanging nodes</a></li>
        
            <li><a href="#anisotropic-refinement">Anisotropic refinement</a></li>
        
            <li><a href="#derefinement">Derefinement</a></li>
        
            <li><a href="#parallel-nonconforming-meshes">Parallel nonconforming meshes</a></li>
        
            <li><a href="#load-balancing">Load balancing</a></li>
        
            <li><a href="#nonconforming-mesh-io">Nonconforming mesh I/O</a></li>
        
    
    
	
           <hr style="background-color:white; height:20px; margin-left:-1px;  margin-right:-1px; margin-top:15px; margin-bottom:10px " />
           <li><a href="../../howto/howto-index/"><i class="fa fa-chevron-circle-left"></i> Back to HowTo Articles</a> </li>
        
	
	
	
    
    </ul>
</div>

<!-- Developer notes:
  See the MkDocs documentation in https://www.mkdocs.org/dev-guide/themes/#page
  and the Jinja2 template API in https://tedboy.github.io/jinja2/index.html
--></div>
            
        </div>
        

        <footer class="footer">
           <div class="container">
              <p class="text-muted alignright">LLNL-WEB-676715</p>
              <p class="text-muted alignleft">
                  Developed by the <a href="/about/">MFEM team</a> at
                  <a href="https://computing.llnl.gov/casc/">CASC</a>,
                  <a href="https://www.llnl.gov/">LLNL</a></p>
           </div>
        </footer>

        <script src="../../js/jquery-1.10.2.min.js"></script>
        <script src="../../js/bootstrap-3.0.3.min.js"></script>
        <script src="../../js/highlight.pack.js"></script>
        <script src="../../js/base.js"></script>
        <script src="../../js/retina.min.js"></script>
        <script data-main="../../mkdocs/js/search.js" src="../../mkdocs/js/require.js"></script>
        <script src="../../search/main.js"></script>
    </body>
</html>